<html>
  <head>
    <link href="css/stylesheet.css" type="text/css" rel="stylesheet">
    <link href="css/jquery.dataTables.min.css" type="text/css" rel="stylesheet">

    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/jquery.dataTables.min.js" type="text/javascript"></script>
    <script src="js/digestAuthRequest.js" type="text/javascript"></script>
    <script src="js/md5.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
        
            $('#loginBtn').click(function() {
                var req = new digestAuthRequest('GET', 'http://localhost:7000/answers', $('#username').val(), $('#password').val());
                req.request(function(json) {
                    if (json.length == 0) {
                        $('#login').hide();
                        $('.completed-message').text('Nothing to display');
                    }

                    var keys = [];
                    for (i = 0; i < json.length; i++) {
                        for (var key in json[i])
                            if (keys.indexOf(key) < 0 && !key.startsWith('video_'))
                                keys.push(key);
                    }
                    keys.sort(function(x, y) {
                        if (x != y) {
                            var x_matches = x.match(/\d+$/);
                            var y_matches = y.match(/\d+$/);
                            if (x_matches && y_matches) {
                                var x_num = parseInt(x_matches[0], 10);
                                var y_num = parseInt(y_matches[0], 10);
                                var x_str = x.substring(0, x.length - x_matches[0].length);
                                var y_str = y.substring(0, y.length - y_matches[0].length);
                                if (x_str == y_str)
                                    return x_num < y_num ? -1 : 1;
                            }
                        }
                        return ( ( x == y ) ? 0 : ( ( x > y ) ? 1 : -1 ) );
                    });

                    var data = [];
                    for (i = 0; i < json.length; i++) {
                        var result = [];
                        for (j = 0; j < keys.length; j++)
                            result.push(json[i][keys[j]]);
                        data.push(result);
                    }

                    var columns = [];
                    for (i = 0; i < keys.length; i++)
                        columns.push({'sTitle': keys[i] });

                    $('#answers').dataTable({
                        "aaData": data,
                        "aoColumns": columns,
                        "columnDefs": [
                            { className: "dt-head-left", "targets": ["_all"] }
                        ]
                    });
                    
                    $('.table_wrapper').css("max-width", $(window).width()-60);
                    $('.wrapper').css("max-width", "none");
                    $('.wrapper').css("min-width", $('#answers').width()+80);
                    
                    $('#login').hide();
                    $('.completed-message').text('');

                },function(errorCode) {
                    $('#login').show();
                    $('.completed-message').text('An error occurred: could not login to server');
                });
            });
      });
    </script>
  </head>
  <body>
    <div class="wrapper">
        <div class="main">
            <h1 style="margin-bottom:30px;">Video Experience Experiment - Answers</h1>
            
            <div id="login">
                <table>
                    <tr><td>Username:</td><td><input type="text" id="username" /></td></tr>
                    <tr><td>Password:</td><td><input type="password" id="password" /></td></tr>
                    <tr><td></td><td align="right"><a id="loginBtn" href="#" class="button">Login</a></td></tr>
                </table>
            </div>
            
            <div class="table_wrapper"><table id="answers" class="display" cellspacing="0" width="100%"></table></div>
            
            <div class="completed-message"></div>
        </div>
    </div>
  </body>
</html>
